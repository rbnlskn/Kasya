name: Batch Issue Context and Agent Trigger
on:
  issues:
    types: [labeled]

jobs:
  activate_and_process_batch:
    # 1. Trigger only when the 'Ready' label is added
    if: github.event.label.name == 'Ready'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
    steps:
      - name: 1. Initialization and Label Change (Ready -> Hydrate Context)
        id: initialization
        uses: actions/github-script@v7
        with:
          # CRITICAL: Use PAT here for label manipulation that affects other systems (like Jules)
          github-token: ${{ secrets.JULES_PAT }}
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const actor = context.actor;

            // Remove 'Ready' and 'Backlog' labels
            const labelsToRemove = ['Ready', 'Backlog'];
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({ owner, repo, issue_number: issueNumber, name: label });
              } catch (e) { /* Ignore if label wasn't there */ }
            }

            // Assign YOU to the issue
            await github.rest.issues.addAssignees({ owner, repo, issue_number: issueNumber, assignees: [actor] });

            // Add the intermediate 'Hydrate Context' label
            await github.rest.issues.addLabels({ owner, repo, issue_number: issueNumber, labels: ['Hydrate Context'] });

            // Pass the issue number and actor to the next step
            const core = require('@actions/core');
            core.setOutput('issue_number', issueNumber);


      - name: 2. Process Sub-Issues and Load Context
        id: context_loading
        uses: actions/github-script@v6
        with:
          script: |
            const issueNumber = ${{ steps.initialization.outputs.issue_number }};
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const core = require('@actions/core');

            // Fetch the issue body (must be refetched after the first step's changes if any)
            const issue = await github.rest.issues.get({ owner, repo, issue_number: issueNumber });
            const issueBody = issue.data.body;

            const issueRegex = /#(\d+)/g;
            const matches = [...issueBody.matchAll(issueRegex)];
            
            if (matches.length === 0) {
              console.log("No linked issues found. Skipping hydration.");
              core.setOutput('context_added', 'false');
              return;
            }
            
            let consolidatedContent = "\n\n---\n# üß† CONSOLIDATED CONTEXT (AUTO-GENERATED)\n";
            consolidatedContent += "> **System Note:** The following content is merged from sub-issues to ensure a SINGLE session context.\n\n";

            // Loop through sub-issues, update them, and grab content
            for (const match of matches) {
              const linkedId = parseInt(match[1]);
              if (linkedId === issueNumber) continue;

              try {
                const linkedIssue = await github.rest.issues.get({ owner, repo, issue_number: linkedId });

                consolidatedContent += `## üìÑ Sub-Issue #${linkedId}: ${linkedIssue.data.title}\n`;
                consolidatedContent += `${linkedIssue.data.body}\n`;
                consolidatedContent += `\n---\n`;

                await github.rest.issues.createComment({
                  owner, repo, issue_number: linkedId,
                  body: `‚öôÔ∏è **Status Update:** This issue is currently being processed in Batch Issue #${issueNumber}. Please follow that issue for updates.`
                });

                const labels = linkedIssue.data.labels.map(l => l.name);
                if (labels.includes('Jules')) { 
                   await github.rest.issues.removeLabel({ owner, repo, issue_number: linkedId, name: 'Jules' });
                }

              } catch (error) {
                console.log(`Error processing #${linkedId}: ${error.message}`);
              }
            }

            // Add Memory Instructions
            consolidatedContent += `
            # üíæ MEMORY & FINALIZATION INSTRUCTIONS
            1. **Execute All Tasks:** Resolve the sub-issues listed above in this single session.
            2. **Update Memory:** Upon completion, analyze the patterns used in this fix.
            3. **Documentation:** If new architectural rules were established, update 'AGENTS.md' so you remember them next time.
            `;

            // Update the Batch Issue Body with all the text
            await github.rest.issues.update({ owner, repo, issue_number: issueNumber, body: issueBody + consolidatedContent });
            
            core.setOutput('context_added', 'true');


      - name: 3. Final Label Change (Hydrate Context -> Jules)
        # This step runs even if context loading failed (to clean up the status label)
        if: always() 
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.JULES_PAT }} # Using PAT to ensure agent trigger works
          script: |
            const issueNumber = ${{ steps.initialization.outputs.issue_number }};
            const contextAdded = "${{ steps.context_loading.outputs.context_added }}" === 'true';
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Always remove the 'Hydrate Context' status label
            await github.rest.issues.removeLabel({
              owner, repo, issue_number: issueNumber, name: 'Hydrate Context'
            });

            // Only add the 'Jules' trigger if context was successfully loaded.
            if (contextAdded) {
                await github.rest.issues.addLabels({
                    owner, repo, issue_number: issueNumber, labels: ['Jules']
                });
            } else {
                // If no sub-issues were found, notify the user.
                await github.rest.issues.createComment({
                    owner, repo, issue_number: issueNumber,
                    body: "‚ö†Ô∏è **Context Processor:** No linked sub-issues found (e.g., #123). Jules was NOT triggered. Please apply the 'Jules' label manually when ready."
                });
            }

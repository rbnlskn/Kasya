name: Update Status on Jules Comment
on:
  issue_comment:
    types: [created]

jobs:
  update-status:
    if: contains(github.event.comment.user.login, 'jules')
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Update Label and Cleanup
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.comment.body.toLowerCase();
            const labelsToRemove = ['Backlog', 'Ready', 'In Progress', 'For Review'];
            
            // Helper function to remove a list of labels
            async function removeOldLabels(names) {
              for (const name of names) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    name: name
                  });
                } catch (e) {} // Ignore if missing
              }
            }

            // SCENARIO 1: Jules opened a PR -> Move to 'For Review'
            if (body.includes('pull request') || body.includes('/pull/')) {
              // Remove everything that isn't 'Done'
              await removeOldLabels(labelsToRemove);
              
              // Add 'For Review'
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['For Review']
              });
            } 
            
            // SCENARIO 2: Jules is just working -> Move to 'In Progress'
            else {
              // Check if it's ALREADY 'For Review' (don't downgrade it)
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              const isReview = issue.labels.some(l => l.name === 'For Review');

              if (!isReview) {
                // Remove 'Backlog' and 'Ready'
                await removeOldLabels(['Backlog', 'Ready']);

                // Add 'In Progress'
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: ['In Progress']
                });
              }
            }

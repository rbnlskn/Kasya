name: Kasya Workflow Automation

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  issue_reaction:
    types: [created]
  pull_request:
    types: [closed]

permissions:
  issues: write
  pull-requests: read
  contents: write

jobs:
  activate_batch:
    if: github.event.label.name == 'ready'
    runs-on: ubuntu-latest
    steps:
      - name: Build Context and Trigger Planning
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.JULES_PAT }} 
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const actor = context.actor;

            const labelsToRemove = ['backlog', 'ready'];
            for (const name of labelsToRemove) {
              try { await github.rest.issues.removeLabel({ owner, repo, issue_number: issueNumber, name }); } catch (e) {} 
            }
            
            await github.rest.issues.addAssignees({ owner, repo, issue_number: issueNumber, assignees: [actor] });

            const issue = await github.rest.issues.get({ owner, repo, issue_number: issueNumber });
            const body = issue.data.body || "";
            const issueRegex = /#(\d+)/g;
            const matches = [...body.matchAll(issueRegex)];
            
            let contextContent = "\n\n---\n# üß† CONSOLIDATED CONTEXT\n";
            contextContent += "> **System Note:** Merged content from sub-issues.\n\n";

            if (matches.length > 0) {
              await github.rest.issues.addLabels({ owner, repo, issue_number: issueNumber, labels: ['context'] });
              for (const match of matches) {
                const subId = parseInt(match[1]);
                if (subId === issueNumber) continue;
                try {
                  const subIssue = await github.rest.issues.get({ owner, repo, issue_number: subId });
                  try { await github.rest.issues.removeLabel({ owner, repo, issue_number: subId, name: 'backlog' }); } catch(e){}
                  await github.rest.issues.addLabels({ owner, repo, issue_number: subId, labels: ['in progress'] });
                  contextContent += `## üìÑ Sub-Issue #${subId}: ${subIssue.data.title}\n${subIssue.data.body}\n\n---\n`;
                } catch (e) {}
              }
            }

            await github.rest.issues.update({ owner, repo, issue_number: issueNumber, body: body + contextContent });
            try { await github.rest.issues.removeLabel({ owner, repo, issue_number: issueNumber, name: 'context' }); } catch(e){}
            
            await github.rest.issues.addLabels({ 
              owner, repo, issue_number: issueNumber, 
              labels: ['jules', 'planning'] 
            });

  approve_plan:
    if: github.event_name == 'issue_reaction' && github.event.reaction.content == '+1'
    runs-on: ubuntu-latest
    steps:
      - name: Switch Planning to In Progress
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.JULES_PAT }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNumber = context.issue.number;
            
            const issue = await github.rest.issues.get({ owner, repo, issue_number: issueNumber });
            const labels = issue.data.labels.map(l => l.name);
            
            if (labels.includes('planning')) {
              await github.rest.issues.removeLabel({ owner, repo, issue_number: issueNumber, name: 'planning' });
              
              await github.rest.issues.addLabels({ 
                owner, repo, issue_number: issueNumber, 
                labels: ['in progress', 'jules'] 
              });
              
              await github.rest.issues.createComment({
                owner, repo, issue_number: issueNumber,
                body: "üëç **Plan Approved.** Jules is starting execution now."
              });
            }

  update_status_review:
    if: github.event_name == 'issue_comment' && contains(github.event.comment.user.login, 'jules')
    runs-on: ubuntu-latest
    steps:
      - name: Move to Review
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.comment.body.toLowerCase();
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            if (body.includes('pull request') || body.includes('/pull/')) {
              try { await github.rest.issues.removeLabel({ owner, repo, issue_number: issueNumber, name: 'in progress' }); } catch(e){}
              await github.rest.issues.addLabels({ owner, repo, issue_number: issueNumber, labels: ['in review'] });
            }

  close_on_merge:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Close Batch and Sub-Issues
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const body = pr.body || "";

            const issueRegex = /#(\d+)/g;
            const matches = [...body.matchAll(issueRegex)];
            
            if (matches.length === 0) return;

            for (const match of matches) {
              const batchId = parseInt(match[1]);
              
              try { await github.rest.issues.removeLabel({ owner, repo, issue_number: batchId, name: 'in review' }); } catch(e){}
              await github.rest.issues.addLabels({ owner, repo, issue_number: batchId, labels: ['completed'] });
              await github.rest.issues.update({ owner, repo, issue_number: batchId, state: 'closed' });

              const batchIssue = await github.rest.issues.get({ owner, repo, issue_number: batchId });
              const subMatches = [...(batchIssue.data.body || "").matchAll(issueRegex)];
              for (const sub of subMatches) {
                   const subId = parseInt(sub[1]);
                   if (subId === batchId) continue;
                   try {
                     try { await github.rest.issues.removeLabel({ owner, repo, issue_number: subId, name: 'in progress' }); } catch(e){}
                     await github.rest.issues.addLabels({ owner, repo, issue_number: subId, labels: ['completed'] });
                     await github.rest.issues.update({ owner, repo, issue_number: subId, state: 'closed' });
                   } catch(err) {}
              }
            }

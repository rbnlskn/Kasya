name: Kasya Workflow Automation

on:
  # 1. Manual Trigger with Input (Forcing it to run on specific issue)
  workflow_dispatch:
    inputs:
      debug_issue_number:
        description: 'Issue Number to Test (e.g., 40)'
        required: true
        default: '40'
  # 2. Automatic Triggers
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]
  issue_reaction:
    types: [created]
  pull_request:
    types: [closed]

permissions:
  issues: write
  pull-requests: read
  contents: write

jobs:
  # ------------------------------------------------------------------
  # THE MANAGER JOB (Runs on EVERY event, filters inside steps)
  # ------------------------------------------------------------------
  kasya_manager:
    runs-on: ubuntu-latest
    steps:
      # STEP 1: Debug Log (This will ALWAYS run, proving the file works)
      - name: ğŸ” Diagnostic Log
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Actor: ${{ github.actor }}"

      # STEP 2: Logic Router (Decides what to do based on the event)
      - name: ğŸ§  Router & Execution
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.JULES_PAT }}
          script: |
            // ---------------- INITIALIZATION ----------------
            const event = context.eventName;
            const payload = context.payload;
            let issueNumber = null;
            let triggerType = null;

            // DETERMINE CONTEXT BASED ON EVENT
            if (event === 'workflow_dispatch') {
              issueNumber = parseInt('${{ inputs.debug_issue_number }}');
              console.log(`ğŸ”§ MANUAL DEBUG MODE: Targeting Issue #${issueNumber}`);
              triggerType = 'ACTIVATE'; // Manual runs force activation
            } 
            else if (event === 'issues') {
              issueNumber = context.issue.number;
              const labels = payload.issue.labels || [];
              const hasReady = labels.some(l => l.name === 'ready');
              
              if (hasReady) {
                 console.log(`âœ… Issue #${issueNumber} has 'ready' label. Activating.`);
                 triggerType = 'ACTIVATE';
              } else {
                 console.log(`â„¹ï¸ Issue #${issueNumber} does NOT have 'ready' label. Ignoring.`);
                 return; // EXIT SCRIPT
              }
            }
            else if (event === 'issue_reaction' && payload.reaction.content === '+1') {
               issueNumber = context.issue.number;
               triggerType = 'APPROVE_PLAN';
            }
            else if (event === 'issue_comment') {
               issueNumber = context.issue.number;
               if (payload.comment.user.login.toLowerCase().includes('jules')) {
                 triggerType = 'UPDATE_STATUS';
               }
            }
            else if (event === 'pull_request' && payload.pull_request.merged === true) {
               triggerType = 'CLOSE_MERGE';
            }

            if (!triggerType) {
              console.log("â›” No matching logic for this event. Stopping.");
              return;
            }

            // ---------------- LOGIC HANDLERS ----------------
            
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // HANDLER 1: ACTIVATION (Ready -> Jules)
            if (triggerType === 'ACTIVATE') {
              // Cleanup Labels
              const labelsToRemove = ['backlog', 'ready'];
              for (const name of labelsToRemove) {
                try { await github.rest.issues.removeLabel({ owner, repo, issue_number: issueNumber, name }); } catch (e) {} 
              }
              
              // Assign User
              await github.rest.issues.addAssignees({ owner, repo, issue_number: issueNumber, assignees: [context.actor] });

              // Build Context
              const issue = await github.rest.issues.get({ owner, repo, issue_number: issueNumber });
              const body = issue.data.body || "";
              const matches = [...body.matchAll(/#(\d+)/g)];
              
              let contextContent = "\n\n---\n# ğŸ§  CONSOLIDATED CONTEXT\n> **System Note:** Merged content from sub-issues.\n\n";

              if (matches.length > 0) {
                await github.rest.issues.addLabels({ owner, repo, issue_number: issueNumber, labels

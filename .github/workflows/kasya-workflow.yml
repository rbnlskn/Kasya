name: Kasya Workflow

on:
  issues:
    types: [labeled, opened, reopened]
  issue_comment:
    types: [created]
  pull_request:
    types: [closed, opened]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  setup-context:
    name: Setup Batch Context
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'ready'
    runs-on: ubuntu-latest
    steps:
      - name: Process Batch Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.JULES_PAT }}
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const actor = context.actor;

            console.log(`Processing 'ready' label on issue #${issue_number}`);

            // 1. Remove 'backlog' and 'ready' labels
            const labelsToRemove = ['backlog', 'ready'];
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({ owner, repo, issue_number, name: label });
                console.log(`Removed label: ${label}`);
              } catch (e) {
                console.log(`Label ${label} not found or error removing.`);
              }
            }

            // 2. Assign Batch Issue to Actor
            try {
              await github.rest.issues.addAssignees({
                owner, repo, issue_number, assignees: [actor]
              });
              console.log(`Assigned issue to ${actor}`);
            } catch (e) {
              console.log(`Error assigning issue: ${e.message}`);
            }

            // 3. Identify Sub-issues
            const { data: batchIssue } = await github.rest.issues.get({ owner, repo, issue_number });
            const body = batchIssue.body || "";
            // Regex to find #123
            const issueMatches = body.match(/#(\d+)/g) || [];
            const subIssueIds = [...new Set(issueMatches
              .map(s => parseInt(s.replace('#', ''), 10))
              .filter(id => id !== issue_number)
            )];

            console.log(`Found sub-issues: ${subIssueIds.join(', ')}`);

            // 4. Process Sub-issues
            let contextSection = "\n\n# Consolidated Context\n";

            for (const id of subIssueIds) {
              try {
                // Remove 'backlog', Add 'in progress'
                try {
                  await github.rest.issues.removeLabel({ owner, repo, issue_number: id, name: 'backlog' });
                } catch (e) {}

                await github.rest.issues.addLabels({ owner, repo, issue_number: id, labels: ['in progress'] });

                // Assign to Actor
                await github.rest.issues.addAssignees({ owner, repo, issue_number: id, assignees: [actor] });

                // Fetch for Context
                const { data: sub } = await github.rest.issues.get({ owner, repo, issue_number: id });
                contextSection += `\n## Issue #${id}: ${sub.title}\n${sub.body || ''}\n`;
                console.log(`Processed sub-issue #${id}`);
              } catch (error) {
                console.log(`Error processing sub-issue #${id}: ${error.message}`);
              }
            }

            // 5. Append Context to Batch Issue
            await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['context'] });

            await github.rest.issues.update({
              owner, repo, issue_number,
              body: body + contextSection
            });
            console.log("Appended Consolidated Context");

            // 6. Add 'in progress' and 'jules' labels
            await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['in progress', 'jules'] });
            console.log("Added 'in progress' and 'jules' labels");

            // 7. Request Plan
            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: "Batch ready. Jules please post the plan."
            });

  review-transition:
    name: Transition to Review
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.JULES_PAT }}
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const commentBody = context.payload.comment.body.toLowerCase();

            const { data: issue } = await github.rest.issues.get({ owner, repo, issue_number });
            const hasInProgress = issue.labels.some(l => l.name === 'in progress');

            if (!hasInProgress) return;

            const isPR = commentBody.includes('pull request') || commentBody.includes('/pull/');

            if (isPR) {
               console.log("PR detected. Transitioning to 'in review'.");
               try {
                 await github.rest.issues.removeLabel({ owner, repo, issue_number, name: 'in progress' });
               } catch(e) {}
               await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['in review'] });
            }

  completion:
    name: Complete Issues
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Close Linked Issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.JULES_PAT }}
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            const prBody = pr.body || "";

            // Regex to find linked issues
            const issueMatches = prBody.match(/#(\d+)/g) || [];
            const linkedIssueIds = [...new Set(issueMatches.map(s => parseInt(s.replace('#', ''), 10)))];

            console.log(`Found linked issues in PR: ${linkedIssueIds.join(', ')}`);

            for (const id of linkedIssueIds) {
               try {
                 // Remove status labels
                 const labelsToRemove = ['in review', 'in progress', 'planning', 'jules', 'context'];
                 for (const label of labelsToRemove) {
                    try { await github.rest.issues.removeLabel({ owner, repo, issue_number: id, name: label }); } catch(e){}
                 }

                 // Close without adding 'completed' label
                 await github.rest.issues.update({ owner, repo, issue_number: id, state: 'closed' });
                 console.log(`Closed issue #${id}`);
               } catch(e) {
                 console.log(`Error closing issue #${id}: ${e.message}`);
               }
            }

  reset-issue-state:
    name: Reset Issue State
    if: github.event_name == 'issues' && (github.event.action == 'opened' || github.event.action == 'reopened')
    runs-on: ubuntu-latest
    steps:
      - name: Reset Labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.JULES_PAT }}
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            // Remove status labels
            const labelsToRemove = ['completed', 'in progress', 'in review', 'jules', 'planning', 'context'];
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({ owner, repo, issue_number, name: label });
              } catch (e) {}
            }

            // Add 'backlog'
            try {
              await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['backlog'] });
            } catch (e) {}

  assign-pr:
    name: Assign PR
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Assign and Request Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.JULES_PAT }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.issue.number;
            const targetUser = 'rbnlskn';

            // Assign
            try {
              await github.rest.issues.addAssignees({
                owner, repo, issue_number: pull_number, assignees: [targetUser]
              });
            } catch (e) {
              console.log(`Error assigning PR: ${e.message}`);
            }

            // Request Review
            try {
              await github.rest.pulls.requestReviewers({
                owner, repo, pull_number, reviewers: [targetUser]
              });
            } catch (e) {
              console.log(`Error requesting review: ${e.message}`);
            }

name: Issue Lifecycle

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, closed, review_requested]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  # 1. Start Workflow (Ready -> Context/Assignment)
  start-workflow:
    name: Initialize Issue
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'ready'
    runs-on: ubuntu-latest
    steps:
      - name: Process Ready State
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const actor = context.actor;
            
            // 1. Clean Labels (backlog, ready)
            const labelsToRemove = ['backlog', 'ready'];
            for (const name of labelsToRemove) {
              try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name }); } catch(e){}
            }

            // 2. Assign Actor
            try {
              await github.rest.issues.addAssignees({ owner, repo, issue_number, assignees: [actor] });
            } catch(e) {}

            // 3. Check for [BATCH] Title
            const { data: issue } = await github.rest.issues.get({ owner, repo, issue_number });
            const title = issue.title || "";
            
            if (title.toUpperCase().includes('[BATCH]')) {
                console.log("Batch issue detected. Triggering Context Generation.");
                // Add 'context' label to trigger next step
                await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['context'] });
            } else {
                console.log("Single issue. Waiting for 'working on this' signal.");
                // Optional: You could jump straight to 'planning' or wait. 
                // As per guide: "Assign me" -> "Working on this" -> Planning.
            }

  # 2. Generate Context (Context -> Planning)
  # ONLY runs if 'context' label was added (which means it IS a [BATCH] issue)
  generate-context:
    name: Generate Context (Batch Only)
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'context'
    runs-on: ubuntu-latest
    steps:
      - name: Build Context from Sub-issues
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            
            // 1. Find Sub-issues
            const { data: mainIssue } = await github.rest.issues.get({ owner, repo, issue_number });
            const body = mainIssue.body || "";
            const issueMatches = body.match(/#(\d+)/g) || [];
            const subIssueIds = [...new Set(issueMatches
              .map(s => parseInt(s.replace('#', ''), 10))
              .filter(id => id !== issue_number)
            )];

            // 2. Process Sub-issues
            let contextSection = "\n\n# Consolidated Context\n";
            for (const id of subIssueIds) {
              try {
                // Label Sub-issues
                try { await github.rest.issues.removeLabel({ owner, repo, issue_number: id, name: 'backlog' }); } catch(e){}
                await github.rest.issues.addLabels({ owner, repo, issue_number: id, labels: ['planning'] });
                
                // Fetch Content
                const { data: sub } = await github.rest.issues.get({ owner, repo, issue_number: id });
                contextSection += `\n## Issue #${id}: ${sub.title}\n${sub.body || ''}\n`;
              } catch (e) {}
            }

            // 3. Append Context
            if (subIssueIds.length > 0) {
              await github.rest.issues.update({
                owner, repo, issue_number,
                body: body + contextSection
              });
            }

            // 4. Transition to Planning
            try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name: 'context' }); } catch(e){}
            await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['planning'] });

  # 3. Transitions (Comment Triggers)
  handle-comments:
    name: Handle State Transitions
    if: github.event_name == 'issue_comment' && github.event.action == 'created'
    runs-on: ubuntu-latest
    steps:
      - name: Check Keywords
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const body = context.payload.comment.body.toLowerCase();
            const { data: issue } = await github.rest.issues.get({ owner, repo, issue_number });
            const labels = issue.labels.map(l => l.name);

            // A. "Working on this" -> Planning + Antigravity
            if (body.includes('working on this')) {
               // Remove context/ready just in case
               const remove = ['context', 'ready', 'backlog'];
               for(const l of remove) try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name: l }); } catch(e){}
               
               // Add Planning + Antigravity
               await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['planning', 'antigravity'] });
               console.log("Transitioned to Planning + Antigravity");
            }

            // B. "Plan Approved" -> In Progress
            if ((body.includes('approved') || body.includes('lgtm')) && labels.includes('planning')) {
               try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name: 'planning' }); } catch(e){}
               await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['in progress'] });
               
               // Confirm
               await github.rest.issues.createComment({
                 owner, repo, issue_number,
                 body: "Plan approved. Switching to 'in progress'."
               });
            }
            
            // C. "Merged" / Closing - Handled by PR logic mostly, but if user says "Fixed", we could close.

  # 4. PR Management
  pr-management:
    name: PR Automation
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Handle PR Labels
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.issue.number;
            const action = context.payload.action;
            const pr = context.payload.pull_request;

            // Opened -> In Review
            if (action === 'opened') {
               await github.rest.issues.addLabels({ owner, repo, issue_number: pr_number, labels: ['in review'] });
               
               // Link to issues? (Optional: Find linked issues and move them to 'in review')
               const body = pr.body || "";
               const issueMatches = body.match(/#(\d+)/g) || [];
               const linkedIds = [...new Set(issueMatches.map(s => parseInt(s.replace('#', ''), 10)))];
               for (const id of linkedIds) {
                   try {
                       await github.rest.issues.removeLabel({ owner, repo, issue_number: id, name: 'in progress' });
                       await github.rest.issues.addLabels({ owner, repo, issue_number: id, labels: ['in review'] });
                   } catch(e){}
               }
            }

            // Closed + Merged -> Close Issues
            if (action === 'closed' && pr.merged) {
               const body = pr.body || "";
               const issueMatches = body.match(/#(\d+)/g) || [];
               const linkedIds = [...new Set(issueMatches.map(s => parseInt(s.replace('#', ''), 10)))];
               
               for (const id of linkedIds) {
                   try {
                       // Remove all status labels
                       const allStatuses = ['backlog', 'ready', 'planning', 'in progress', 'in review', 'context', 'antigravity'];
                       for(const l of allStatuses) try { await github.rest.issues.removeLabel({ owner, repo, issue_number: id, name: l }); } catch(e){}
                       
                       // Close
                       await github.rest.issues.update({ owner, repo, issue_number: id, state: 'closed' });
                   } catch(e){}
               }
            }
